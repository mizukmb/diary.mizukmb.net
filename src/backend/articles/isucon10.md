+++
title="ISUCON10予選に参加しました"
date="2020-09-14"
+++

http://isucon.net/archives/54704557.html

インターネット蟹工船というチーム名でソロ参加していました。

当日は一人だったので、コードやconfファイルの編集はサーバーから直接いじってました。バックアップとしてローカルに落としておいて、常に変更前がどういう状態だったかを確認できるようにしていました。gitで管理するとか、デプロイスクリプトを作るとかはやりませんでした。

## 当日

ざっくり

- 9時半時起床
- 開始が12時に延長になった。運営がんばれ～
- 出前館でピザを頼む
- 気合を入れるためにエナドリを飲む
- 予選開始
- ピザとエナドリの食べ合わせが悪かったのかめちゃくちゃお腹が痛かった
- ルールを読む。この時点で改善できるポイントが無いか意識しながら読むようにした
- サーバー3台構成か
- ssh_configの設定を済ます
- とりあえず1台にsshしてOS/CPU/Mem/動いてるプロセスを確認
  - CPU1コア2GB?? リソースが少ない…
  - webappとnginxとMySQLが動いてる…。1台で全部やってるの？
- とりあえずwebappの言語をGoからRubyに変更
- webapp/nginx conf/DBテーブル構成の確認・ローカルへのクローンを済ます
- ベンチが使えるようになるまで待機。ルールを読み直したりローカルからのアクセス方法を確認したり
- NewRelicのgemを入れてベンチを回す。400点ぐらいだった気がする
- お腹が痛いので休憩。布団に横になりながらYouTubeを見る
- 復活
- 3台構成だけど1台で全部捌いてるなー。好きに分割していいって事か
- 再度ベンチを回しつつ。topでCPUの状況を確認する
- mysqldがめちゃくちゃCPU使ってる。とりあえずwebapp+nginxとDBで構成わけよう。→わけた
  - nginx までやる必要ないかな…。ネットワークの遅さがボトルネックになりそう
- NewRelicからp99値が遅いAPIを見るという作戦。なぞって検索のコードを見る
- `estates.each` のところ、クエリがN+1っぽいな～。いい感じにできそうだけど案が思いつかぬ… ( `ST_Contains` って何だ…)
- Rubyのコードで遅そうなところを改善するも効果はなさそう
- nazotteは後回しにしよう。access_logとスロークエリ見て方針決めるか
- alpとmyprofilerのインストール。nginxのaccess_logをjson形式に変更
  - 使い方わすれたなー。とりあえずREADMEのコマンドで見れればいいか…
- chairとestateのsearchもリクエスト回数多い+p99値も0.9msぐらいでそこそこ遅い。見てみるか
- `count` は `COUNT(*)` するまでもないよなー。 `LIMIT` つけずに全部取ってきてアプリ側でページングの処理した方が早そうかな
- ベンチ回したけどあんまり変らず
- DBのインデックスを貼るかー。とりあえず両方のidに貼っておこう (SELECTしてるところはあったので効果はあるはず)
  - 変わんねー
- というか、余ったサーバーどうしよう。無難なのはnginxとwebappをわけるだけど、早くなる根拠が無いんだよなあ
  - やるだけやってみるということで分割したら得点が200点まで下がった :pien:
- レコメンドのAPIも遅いなー。クエリも WHERE が冗長な感じもするし、改善できそう
- 要は物件のドアを通れる椅子を探せばよいんだけど、何度か変更してベンチ回したけどダメだった
- この時点ではもうあんまり時間がなくて諦めた

## 最終スコア

225点

まあ、0点じゃなかっただけ…

## 感想

3年ぶりとはいえ、どうやって計測するかとか、最初の準備はどうしたら良いかは迷わずできたのはよかったかなと思います

初めてソロ参戦しましたが、相談相手がいないのはつらいなーという感想でした。サーバー直接いじっても開発速度に影響でないのは気楽でしたが、孤独はつらいなあ。

---

ということで久しぶりにISUCONに参加しました。やってみると悔しい気持ちが強いので、リベンジしたい！

運営の皆様、企画から当日までの運営、ありがとうございました。
